"0","# ---- 4. Plot: ABSOLUTE (Incidence) vs. SEER ----"
"0","#        We rename it to avoid collision with the cumulative function."
"0","#        This uses the PDF (weibull_pdf)."
"0","plot_penetrance_comparison_absolute <- function(data, data_noImp, db_sim,"
"0","                                                prob, max_age, cancer, gene, sex, race, type,"
"0","                                                competing_method_incidence = NULL,"
"0","                                                include_age_imputation = TRUE) {"
"0","  # Helper function to calculate incidence"
"0","  calculate_incidence <- function(data, sex) {"
"0","    params <- if (sex == ""Male"") {"
"0","      calculate_weibull_parameters("
"0","        data$median_male_results,"
"0","        data$first_quartile_male_results,"
"0","        data$threshold_male_results"
"0","      )"
"0","    } else {"
"0","      calculate_weibull_parameters("
"0","        data$median_female_results,"
"0","        data$first_quartile_female_results,"
"0","        data$threshold_female_results"
"0","      )"
"0","    }"
"0","    alpha <- params$alpha"
"0","    beta <- params$beta"
"0","    threshold <- if (sex == ""Male"") data$threshold_male_results else data$threshold_female_results"
"0","    asymptote <- if (sex == ""Male"") data$asymptote_male_results else data$asymptote_female_results"
"0",""
"0","    x_vals <- seq(1, max_age)"
"0","    mapply(function(a, b, th, asy) {"
"0","      weibull_pdf(x_vals, a, b, th, asy)"
"0","    }, alpha, beta, threshold, asymptote, SIMPLIFY = FALSE)"
"0","  }"
"0",""
"0","  # Calculate incidence for imputed and non-imputed data"
"0","  inc_list <- calculate_incidence(data, sex)"
"0","  inc_mat <- matrix(unlist(inc_list), nrow = length(seq(1, max_age)), byrow = FALSE)"
"0",""
"0","  inc_list_noImp <- calculate_incidence(data_noImp, sex)"
"0","  inc_mat_noImp <- matrix(unlist(inc_list_noImp), nrow = length(seq(1, max_age)), byrow = FALSE)"
"0",""
"0","  mean_inc <- rowMeans(inc_mat, na.rm = TRUE)"
"0","  mean_inc_noImp <- rowMeans(inc_mat_noImp, na.rm = TRUE)"
"0",""
"0","  lower_prob <- (1 - prob) / 2"
"0","  upper_prob <- 1 - lower_prob"
"0",""
"0","  lower_ci <- apply(inc_mat, 1, quantile, probs = lower_prob, na.rm = TRUE)"
"0","  upper_ci <- apply(inc_mat, 1, quantile, probs = upper_prob, na.rm = TRUE)"
"0",""
"0","  lower_ci_noImp <- apply(inc_mat_noImp, 1, quantile, probs = lower_prob, na.rm = TRUE)"
"0","  upper_ci_noImp <- apply(inc_mat_noImp, 1, quantile, probs = upper_prob, na.rm = TRUE)"
"0",""
"0","  # Retrieve SEER data"
"0","  dim_names <- attr(db_sim$Penetrance, ""dimnames"")"
"0","  c_idx <- which(dim_names[[1]] == cancer)"
"0","  g_idx <- which(dim_names[[2]] == gene)"
"0","  r_idx <- which(dim_names[[3]] == race)"
"0","  s_idx <- which(dim_names[[4]] == sex)"
"0","  t_idx <- which(dim_names[[6]] == type)"
"0",""
"0","  seer_incidence <- db_sim$Penetrance[c_idx, g_idx, r_idx, s_idx, , t_idx]"
"0","  age_values <- seq_along(seer_incidence)"
"0","  min_len <- min(length(seer_incidence), length(mean_inc))"
"0",""
"0","  # Dataframe for plotting"
"0","  df <- data.frame("
"0","    age = age_values[1:min_len],"
"0","    seer_density = seer_incidence[1:min_len],"
"0","    mean_density = mean_inc[1:min_len],"
"0","    mean_density_noImp = mean_inc_noImp[1:min_len],"
"0","    lower_ci = lower_ci[1:min_len],"
"0","    upper_ci = upper_ci[1:min_len],"
"0","    lower_ci_noImp = lower_ci_noImp[1:min_len],"
"0","    upper_ci_noImp = upper_ci_noImp[1:min_len]"
"0","  )"
"0",""
"0","  # Plot"
"0","  p <- ggplot(df, aes(x = age)) +"
"0","    geom_line(aes(y = seer_density, color = ""SEER Baseline""),"
"0","              linewidth = 1, linetype = ""solid"") +"
"0","    geom_line(aes(y = mean_density, color = ""PGV - With Age Imputation""),"
"0","              linewidth = 1, linetype = ""dotted"") +"
"0","    geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci),"
"0","                alpha = 0.2, fill = ""red"") +"
"0","    geom_line(aes(y = mean_density_noImp, color = ""PGV - No Age Imputation""),"
"0","              linewidth = 1, linetype = ""dashed"") +"
"0","    geom_ribbon(aes(ymin = lower_ci_noImp, ymax = upper_ci_noImp),"
"0","                alpha = 0.2, fill = ""blue"") +"
"0","    labs(title = paste(""Incidence Comparison for"", sex, ""in"", race),"
"0","         x = ""Age"", y = ""Incidence (Absolute)"") +"
"0","    theme_minimal() +"
"0","    scale_color_manual(values = c("
"0","      ""SEER Baseline"" = ""black"","
"0","      ""PGV - With Age Imputation"" = ""red"","
"0","      ""PGV - No Age Imputation"" = ""blue"""
"0","    )) +"
"0","    theme(legend.title = element_blank(),"
"0","          legend.position = ""top"")"
"0",""
"0","  # Overlay competing method if provided"
"0","  if (!is.null(competing_method_incidence)) {"
"0","    comp_len <- min(length(seq(1, max_age)), length(competing_method_incidence))"
"0","    comp_df <- data.frame("
"0","      age = seq(1, max_age)[1:comp_len],"
"0","      comp = competing_method_incidence[1:comp_len]"
"0","    )"
"0","    p <- p +"
"0","      geom_line(data = comp_df, aes(x = age, y = comp, color = ""Competing Method""),"
"0","                linetype = ""dotdash"", linewidth = 1) +"
"0","      scale_color_manual(values = c("
"0","        ""SEER Baseline"" = ""black"","
"0","        ""PGV - With Age Imputation"" = ""red"","
"0","        ""PGV - No Age Imputation"" = ""blue"","
"0","        ""Competing Method"" = ""green4"""
"0","      ))"
"0","  }"
"0",""
"0","  print(p)"
"0","}"
"0",""
