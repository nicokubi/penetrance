"0","process_pedigree_data <- function(dat) {"
"0","    ###########################################"
"0","    # USER CONFIGURATION - MODIFY AS NEEDED"
"0","    ###########################################"
"0","    AGE_MIN <- 1"
"0","    AGE_MAX <- 94"
"0",""
"0","    calculate_cur_age <- function(year_birth, year_death, year_last_follow_up) {"
"0","        ifelse(!is.na(year_birth),"
"0","            ifelse(!is.na(year_death) | !is.na(year_last_follow_up),"
"0","                pmin(year_death, year_last_follow_up, na.rm = TRUE) - year_birth,"
"0","                NA"
"0","            ),"
"0","            NA"
"0","        )"
"0","    }"
"0",""
"0","    col_mapping <- c("
"0","        ""Pedigreename"" = ""PedigreeID"","
"0","        ""PedigreeIndividualID"" = ""ID"","
"0","        ""Gender"" = ""Sex"","
"0","        ""PedigreeMotherID"" = ""MotherID"","
"0","        ""PedigreeFatherID"" = ""FatherID"","
"0","        ""probandflag"" = ""isProband"","
"0","        ""Colorectal"" = ""isAff"","
"0","        ""Colorectal_AgeDx"" = ""Age"","
"0","        ""GT.Pos"" = ""geno"","
"0","        ""GT.Neg"" = ""geno_neg"""
"0","    )"
"0",""
"0","    constrain_age <- function(age, min_age = AGE_MIN, max_age = AGE_MAX) {"
"0","        ifelse(age > max_age, max_age,"
"0","            ifelse(age < min_age, min_age, age)"
"0","        )"
"0","    }"
"0",""
"0","    stats <- list("
"0","        removed_sex = 0,"
"0","        invalid_age = 0,"
"0","        na_cur_age = 0"
"0","    )"
"0",""
"0","    ###########################################"
"0","    # COMBINE ALL FAMILIES"
"0","    ###########################################"
"0","    df <- do.call(rbind, dat)"
"0",""
"0","    ###########################################"
"0","    # MAIN PROCESSING LOGIC"
"0","    ###########################################"
"0","    "
"0","    # Rename columns"
"0","    for (old_name in names(col_mapping)) {"
"0","        if (old_name %in% colnames(df)) {"
"0","            colnames(df)[colnames(df) == old_name] <- col_mapping[old_name]"
"0","        }"
"0","    }"
"0",""
"0","    # Convert necessary columns to appropriate types"
"0","    df$WorkingBirthYear <- as.numeric(df$WorkingBirthYear)"
"0","    df$YEARDeath <- as.numeric(df$YEARDeath)"
"0","    df$WorkingCensorYear <- as.numeric(df$WorkingCensorYear)"
"0","    df$YearLastFolUp <- as.numeric(df$YearLastFolUp)"
"0",""
"0","    # Calculate CurAge"
"0","    df$CurAge <- calculate_cur_age(df$WorkingBirthYear, df$YEARDeath, df$WorkingCensorYear)"
"0","    df$CurAge <- ifelse(df$CurAge < 0, NA, df$CurAge)"
"0",""
"0","    # Process Sex"
"0","    initial_rows <- nrow(df)"
"0","    df$Sex <- ifelse(df$Sex == ""M"", 1, ifelse(df$Sex == ""F"", 0, NA))"
"0","    stats$removed_sex <- sum(is.na(df$Sex))"
"0","    df <- df[!is.na(df$Sex), ]"
"0",""
"0","    # Process binary columns"
"0","    df$isProband <- ifelse(df$isProband == ""proband"", 1, 0)"
"0","    df$isAff[is.na(df$isAff)] <- 0"
"0","    df$isAff <- ifelse(df$isAff == ""True"", 1, 0)"
"0","    df$geno <- ifelse(df$geno == ""True"", 1,"
"0","        ifelse(df$geno == ""False"", 0, NA)"
"0","    )"
"0","    df$geno_neg <- ifelse(df$geno_neg == ""True"", 1,"
"0","        ifelse(df$geno_neg == ""False"", 0, NA)"
"0","    )"
"0",""
"0","    # Create GT.Pos and GT.Neg"
"0","    df$GT.Pos <- df$geno == 1"
"0","    df$GT.Neg <- df$geno == 0"
"0",""
"0","    # Process ages"
"0","    df$CurAge <- constrain_age(df$CurAge)"
"0","    df$Age <- constrain_age(df$Age)"
"0",""
"0","    # Update isAff based on Age"
"0","    df$isAff <- ifelse(!is.na(df$Age) & df$Age > 0, 1, df$isAff)"
"0",""
"0","    # Validate parent IDs"
"0","    valid_ids <- df$ID"
"0","    df$FatherID <- ifelse(df$FatherID %in% valid_ids, df$FatherID, NA)"
"0","    df$MotherID <- ifelse(df$MotherID %in% valid_ids, df$MotherID, NA)"
"0",""
"0","    # Handle invalid ages for affected individuals"
"0","    df$Age[df$isAff == 1 & (is.na(df$Age) | df$Age < AGE_MIN | df$Age > AGE_MAX)] <- NA"
"0",""
"0","    # Count NA in CurAge"
"0","    stats$na_cur_age <- sum(is.na(df$CurAge))"
"0",""
"0","    # Compute mortality indicators"
"0","    df$with_deathyear <- !is.na(df$YEARDeath)"
"0","    df$without_deathyear <- is.na(df$YEARDeath)"
"0","    df$with_birthyear <- !is.na(df$WorkingBirthYear)"
"0",""
"0","    # Initialize ImputedMortAge"
"0","    df$ImputedMortAge <- NA"
"0",""
"0","    # Calculate existing mortality ages"
"0","    imputed_indices <- df$with_deathyear & df$with_birthyear"
"0","    df$ImputedMortAge[imputed_indices] <- df$YEARDeath[imputed_indices] - df$WorkingBirthYear[imputed_indices]"
"0",""
"0","    # Process mortality by status across ALL data"
"0","    status_list <- c(""GT.Pos"", ""GT.Neg"", ""Other"")"
"0","    "
"0","    for (status in status_list) {"
"0","        if (status %in% c(""GT.Pos"", ""GT.Neg"")) {"
"0","            status_condition <- !is.na(df[[status]]) & df[[status]] == TRUE"
"0","        } else {"
"0","            status_condition <- !is.na(df$GT.Pos) & !is.na(df$GT.Neg) & "
"0","                               !(df$GT.Pos == TRUE | df$GT.Neg == TRUE)"
"0","        }"
"0",""
"0","        age_death_indices <- status_condition & !is.na(df$YEARDeath) & !is.na(df$WorkingBirthYear)"
"0","        age_death <- df$YEARDeath[age_death_indices] - df$WorkingBirthYear[age_death_indices]"
"0","        age_death <- age_death[!is.na(age_death)]"
"0",""
"0","        to_be_imputed <- df$without_deathyear & df$with_birthyear & status_condition"
"0","        num_to_impute <- sum(to_be_imputed)"
"0",""
"0","        if (length(age_death) > 0 && num_to_impute > 0) {"
"0","            imputed_ages <- sample(age_death, num_to_impute, replace = TRUE)"
"0","            df$ImputedMortAge[to_be_imputed] <- imputed_ages"
"0",""
"0","            # Validate imputed ages"
"0","            imputed_indices <- which(to_be_imputed)"
"0","            exceed_2024 <- (df$ImputedMortAge[imputed_indices] + df$WorkingBirthYear[imputed_indices]) > 2024"
"0","            below_lfu <- (df$ImputedMortAge[imputed_indices] + df$WorkingBirthYear[imputed_indices]) < df$YearLastFolUp[imputed_indices]"
"0",""
"0","            invalid_indices <- imputed_indices[exceed_2024 | below_lfu]"
"0","            df$ImputedMortAge[invalid_indices] <- NA"
"0",""
"0","            # Print statistics"
"0","            cat(sprintf("
"0","                ""Status %s: Used %d ages (mean %.1f) to impute %d cases (successful: %d, mean %.1f)\n"","
"0","                status,"
"0","                length(age_death),"
"0","                mean(age_death),"
"0","                num_to_impute,"
"0","                sum(!is.na(df$ImputedMortAge[to_be_imputed])),"
"0","                mean(df$ImputedMortAge[to_be_imputed], na.rm = TRUE)"
"0","            ))"
"0","        }"
"0","    }"
"0",""
"0","    # Process cancers across ALL data"
"0","    cancer_list <- c(lfs_cancers, ""LFS"", ""Colorectal"", ""Pancreatic"")"
"0",""
"0","    for (cancer in cancer_list) {"
"0","        cancer_column <- cancer"
"0","        agedx_column <- paste0(cancer, ""_AgeDx"")"
"0","        imputed_agedx_column <- paste0(cancer, ""_ImputedAgeDx"")"
"0",""
"0","        df[[imputed_agedx_column]] <- NA"
"0",""
"0","        if (!(cancer_column %in% names(df)) || !(agedx_column %in% names(df))) {"
"0","            next"
"0","        }"
"0",""
"0","        with_agedx <- df[[cancer_column]] == TRUE & !is.na(df[[agedx_column]])"
"0","        without_agedx <- df[[cancer_column]] == TRUE & is.na(df[[agedx_column]])"
"0","        AgeDx <- df[[agedx_column]][with_agedx]"
"0",""
"0","        df[[imputed_agedx_column]][with_agedx] <- df[[agedx_column]][with_agedx]"
"0",""
"0","        for (status in status_list) {"
"0","            if (status %in% c(""GT.Pos"", ""GT.Neg"")) {"
"0","                status_condition <- !is.na(df[[status]]) & df[[status]] == TRUE"
"0","            } else {"
"0","                status_condition <- !is.na(df$GT.Pos) & !is.na(df$GT.Neg) & "
"0","                                   !(df$GT.Pos == TRUE | df$GT.Neg == TRUE)"
"0","            }"
"0","            "
"0","            to_be_imputed <- without_agedx & status_condition"
"0","            num_to_impute <- sum(to_be_imputed)"
"0",""
"0","            if (length(AgeDx) > 0 && num_to_impute > 0) {"
"0","                imputed_ages <- sample(AgeDx, num_to_impute, replace = TRUE)"
"0","                df[[imputed_agedx_column]][to_be_imputed] <- imputed_ages"
"0","                "
"0","                cat(sprintf("
"0","                    ""Cancer %s, Status %s: Used %d ages (mean %.1f) to impute %d cases (mean %.1f)\n"","
"0","                    cancer,"
"0","                    status,"
"0","                    length(AgeDx),"
"0","                    mean(AgeDx),"
"0","                    num_to_impute,"
"0","                    mean(df[[imputed_agedx_column]][to_be_imputed], na.rm = TRUE)"
"0","                ))"
"0","            }"
"0","        }"
"0","    }"
"0",""
"0","    # Split back into families"
"0","    dat_processed <- split(df, df$PedigreeID)"
"0",""
"0","    return(list("
"0","        processed_data = dat_processed,"
"0","        statistics = stats"
"0","    ))"
"0","}"
"0",""
"0","# Usage"
"0","result <- process_pedigree_data(dat)"
"1","Status GT.Pos: Used 538 ages (mean 39.9) to impute 2609 cases (successful: 699, mean 32.5)
"
"1","Status GT.Neg: Used 49 ages (mean 65.8) to impute 1079 cases (successful: 167, mean 52.9)
"
"2","Error in process_pedigree_data(dat) : object 'lfs_cancers' not found
"
