"0","# Functions for single dataset comparisons"
"0","plot_cumulative_vs_seer <- function(data, db_sim, prob, max_age, cancer, gene, sex, race, type) {"
"0","  if (prob <= 0 || prob >= 1) {"
"0","    stop(""prob must be between 0 and 1"")"
"0","  }"
"0",""
"0","  # Calculate densities"
"0","  calculate_densities <- function(data, sex) {"
"0","    params <- if (sex == ""Male"") {"
"0","      calculate_weibull_parameters("
"0","        data$median_male_results,"
"0","        data$first_quartile_male_results,"
"0","        data$threshold_male_results"
"0","      )"
"0","    } else {"
"0","      calculate_weibull_parameters("
"0","        data$median_female_results,"
"0","        data$first_quartile_female_results,"
"0","        data$threshold_female_results"
"0","      )"
"0","    }"
"0","    "
"0","    alphas <- params$alpha"
"0","    betas <- params$beta"
"0","    thresholds <- if (sex == ""Male"") data$threshold_male_results else data$threshold_female_results"
"0","    asymptotes <- if (sex == ""Male"") data$asymptote_male_results else data$asymptote_female_results"
"0","    "
"0","    mapply(function(alpha, beta, threshold, asymptote) {"
"0","      pweibull(x_values - threshold, shape = alpha, scale = beta) * asymptote"
"0","    }, alphas, betas, thresholds, asymptotes, SIMPLIFY = FALSE)"
"0","  }"
"0",""
"0","  x_values <- seq(1, max_age)"
"0","  cumulative_density <- calculate_densities(data, sex)"
"0","  distributions_matrix <- matrix(unlist(cumulative_density), nrow = length(x_values), byrow = FALSE)"
"0","  "
"0","  # Calculate statistics"
"0","  mean_density <- rowMeans(distributions_matrix, na.rm = TRUE)"
"0","  lower_prob <- (1 - prob) / 2"
"0","  upper_prob <- 1 - lower_prob"
"0","  lower_ci <- apply(distributions_matrix, 1, quantile, probs = lower_prob)"
"0","  upper_ci <- apply(distributions_matrix, 1, quantile, probs = upper_prob)"
"0",""
"0","  # Get SEER data"
"0","  dim_names <- attr(db_sim$Penetrance, ""dimnames"")"
"0","  cancer_index <- which(dim_names[[1]] == cancer)"
"0","  gene_index <- which(dim_names[[2]] == gene)"
"0","  race_index <- which(dim_names[[3]] == race)"
"0","  sex_index <- which(dim_names[[4]] == sex)"
"0","  type_index <- which(dim_names[[6]] == type)"
"0",""
"0","  density_data <- db_sim$Penetrance[cancer_index, gene_index, race_index, sex_index, , type_index]"
"0","  cumulative_density_seer <- cumsum(density_data)"
"0",""
"0","  # Create plotting dataframe"
"0","  age_values <- seq_along(density_data)"
"0","  min_length <- min(length(cumulative_density_seer), length(mean_density))"
"0",""
"0","  plot_df <- data.frame("
"0","    age = age_values[1:min_length],"
"0","    cumulative_density_seer = cumulative_density_seer[1:min_length],"
"0","    mean_density = mean_density[1:min_length],"
"0","    lower_ci = lower_ci[1:min_length],"
"0","    upper_ci = upper_ci[1:min_length]"
"0","  )"
"0",""
"0","  # Create plot"
"0","  ggplot(plot_df, aes(x = age)) +"
"0","    geom_line(aes(y = cumulative_density_seer * 100, color = ""SEER Baseline""), "
"0","              linewidth = 1, linetype = ""solid"", na.rm = TRUE) +"
"0","    geom_line(aes(y = mean_density * 100, color = ""PGV Carriers""), "
"0","              linewidth = 1, linetype = ""dotted"", na.rm = TRUE) +"
"0","    geom_ribbon(aes(ymin = lower_ci * 100, ymax = upper_ci * 100), "
"0","                alpha = 0.2, fill = ""red"", na.rm = TRUE) +"
"0","    labs(title = paste(""Cumulative Density Comparison for"", sex, ""in"", race),"
"0","         x = ""Age"","
"0","         y = ""Cumulative Probability (%)"") +"
"0","    theme_minimal() +"
"0","    scale_color_manual(values = c("
"0","      ""SEER Baseline"" = ""black"","
"0","      ""PGV Carriers"" = ""red"""
"0","    )) +"
"0","    #scale_y_continuous(limits = c(0, 15)) +  # Adjust limits if needed (now in %)"
"0","    theme(legend.title = element_blank(),"
"0","          legend.position = ""top"")"
"0","}"
"0",""
"0","plot_absolute_vs_seer <- function(data, db_sim, prob, max_age, cancer, gene, sex, race, type) {"
"0","  if (prob <= 0 || prob >= 1) {"
"0","    stop(""prob must be between 0 and 1"")"
"0","  }"
"0",""
"0","  # Calculate densities"
"0","  calculate_densities <- function(data, sex) {"
"0","    params <- if (sex == ""Male"") {"
"0","      calculate_weibull_parameters("
"0","        data$median_male_results,"
"0","        data$first_quartile_male_results,"
"0","        data$threshold_male_results"
"0","      )"
"0","    } else {"
"0","      calculate_weibull_parameters("
"0","        data$median_female_results,"
"0","        data$first_quartile_female_results,"
"0","        data$threshold_female_results"
"0","      )"
"0","    }"
"0","    "
"0","    alphas <- params$alpha"
"0","    betas <- params$beta"
"0","    thresholds <- if (sex == ""Male"") data$threshold_male_results else data$threshold_female_results"
"0","    asymptotes <- if (sex == ""Male"") data$asymptote_male_results else data$asymptote_female_results"
"0","    "
"0","    mapply(function(alpha, beta, threshold, asymptote) {"
"0","      dweibull(x_values - threshold, shape = alpha, scale = beta) * asymptote"
"0","    }, alphas, betas, thresholds, asymptotes, SIMPLIFY = FALSE)"
"0","  }"
"0",""
"0","  x_values <- seq(1, max_age)"
"0","  density <- calculate_densities(data, sex)"
"0","  distributions_matrix <- matrix(unlist(density), nrow = length(x_values), byrow = FALSE)"
"0","  "
"0","  # Calculate statistics"
"0","  mean_density <- rowMeans(distributions_matrix, na.rm = TRUE)"
"0","  lower_prob <- (1 - prob) / 2"
"0","  upper_prob <- 1 - lower_prob"
"0","  lower_ci <- apply(distributions_matrix, 1, quantile, probs = lower_prob)"
"0","  upper_ci <- apply(distributions_matrix, 1, quantile, probs = upper_prob)"
"0",""
"0","  # Get SEER data"
"0","  dim_names <- attr(db_sim$Penetrance, ""dimnames"")"
"0","  cancer_index <- which(dim_names[[1]] == cancer)"
"0","  gene_index <- which(dim_names[[2]] == gene)"
"0","  race_index <- which(dim_names[[3]] == race)"
"0","  sex_index <- which(dim_names[[4]] == sex)"
"0","  type_index <- which(dim_names[[6]] == type)"
"0",""
"0","  density_data <- db_sim$Penetrance[cancer_index, gene_index, race_index, sex_index, , type_index]"
"0",""
"0","  # Create plotting dataframe"
"0","  age_values <- seq_along(density_data)"
"0","  min_length <- min(length(density_data), length(mean_density))"
"0",""
"0","  plot_df <- data.frame("
"0","    age = age_values[1:min_length],"
"0","    seer_density = density_data[1:min_length],"
"0","    mean_density = mean_density[1:min_length],"
"0","    lower_ci = lower_ci[1:min_length],"
"0","    upper_ci = upper_ci[1:min_length]"
"0","  )"
"0",""
"0","  # Create plot"
"0","  ggplot(plot_df, aes(x = age)) +"
"0","    geom_line(aes(y = seer_density * 100, color = ""SEER Baseline""), "
"0","              linewidth = 1, linetype = ""solid"", na.rm = TRUE) +"
"0","    geom_line(aes(y = mean_density * 100, color = ""PGV Carriers""), "
"0","              linewidth = 1, linetype = ""dotted"", na.rm = TRUE) +"
"0","    geom_ribbon(aes(ymin = lower_ci * 100, ymax = upper_ci * 100), "
"0","                alpha = 0.2, fill = ""red"", na.rm = TRUE) +"
"0","    labs(title = paste(""Density Comparison for"", sex, ""in"", race),"
"0","         x = ""Age"","
"0","         y = ""Probability (%)"") +"
"0","    theme_minimal() +"
"0","    scale_color_manual(values = c("
"0","      ""SEER Baseline"" = ""black"","
"0","      ""PGV Carriers"" = ""red"""
"0","    )) +"
"0","    #scale_y_continuous(limits = c(0, 0.3)) +  # Adjust limits if needed (now in %)"
"0","    theme(legend.title = element_blank(),"
"0","          legend.position = ""top"")"
"0","}"
"0",""
"0","# Example usage:"
"0","plot_cumulative_vs_seer("
"0","  data = dat$combined_chains,"
"0","  db_sim = PanelPRODatabase,"
"0","  prob = 0.95,"
"0","  max_age = 94,"
"0","  cancer = ""Breast"","
"0","  gene = ""SEER"","
"0","  sex = ""Male"","
"0","  race = ""All_Races"","
"0","  type = ""Net"""
"0",")"
