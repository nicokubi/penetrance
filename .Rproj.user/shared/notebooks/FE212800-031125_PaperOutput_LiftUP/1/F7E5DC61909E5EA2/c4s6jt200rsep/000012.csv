"0","# Function to prepare data for both cumulative and absolute penetrance analysis"
"0","prepare_penetrance_data <- function(pedigree_list) {"
"0","  # Combine all pedigrees into a single dataframe"
"0","  all_data <- do.call(rbind, pedigree_list)"
"0","  "
"0","  # Filter for carriers only (geno == 1)"
"0","  pen_data <- all_data %>%"
"0","    filter(geno == 1)"
"0","  "
"0","  # Create a survival object"
"0","  pen_data$event <- pen_data$isAff"
"0","  pen_data$time <- ifelse(pen_data$isAff == 1, pen_data$Age, pen_data$CurAge)"
"0","  "
"0","  # Remove entries with missing time"
"0","  pen_data <- pen_data %>% filter(!is.na(time))"
"0","  "
"0","  return(pen_data)"
"0","}"
"0",""
"0","# Calculate absolute penetrance (hazard rates by age interval)"
"0","calculate_absolute_penetrance <- function(km_fit, intervals = seq(0, 65, by = 5)) {"
"0","  # Extract survival probabilities"
"0","  surv_summary <- summary(km_fit, times = intervals)"
"0","  "
"0","  # Create dataframe for penetrance calculations"
"0","  pen_df <- data.frame("
"0","    interval_start = intervals[-length(intervals)],"
"0","    interval_end = intervals[-1],"
"0","    surv_start = surv_summary$surv[match(intervals[-length(intervals)], surv_summary$time)],"
"0","    surv_end = surv_summary$surv[match(intervals[-1], surv_summary$time)]"
"0","  )"
"0","  "
"0","  # Replace NA values with appropriate survival probabilities"
"0","  pen_df$surv_start[is.na(pen_df$surv_start)] <- 1"
"0","  "
"0","  # For missing end survival values, use the nearest available value"
"0","  for(i in which(is.na(pen_df$surv_end))) {"
"0","    next_available <- min(which(!is.na(surv_summary$surv) & "
"0","                               surv_summary$time >= pen_df$interval_end[i]))"
"0","    if(length(next_available) > 0) {"
"0","      pen_df$surv_end[i] <- surv_summary$surv[next_available]"
"0","    } else {"
"0","      pen_df$surv_end[i] <- pen_df$surv_start[i]"
"0","    }"
"0","  }"
"0","  "
"0","  # Calculate absolute penetrance for each interval"
"0","  pen_df$absolute_pen <- (pen_df$surv_start - pen_df$surv_end) / pen_df$surv_start"
"0","  pen_df$cumulative_pen <- 1 - pen_df$surv_end"
"0","  "
"0","  return(pen_df)"
"0","}"
"0",""
"0","# Prepare data"
"0","pen_data <- prepare_penetrance_data(dat_adjusted)"
"0",""
"0","# Create overall Kaplan-Meier fit"
"0","km_fit_overall <- survfit(Surv(time, event) ~ 1, data = pen_data)"
"0",""
"0","# Create sex-specific Kaplan-Meier fits"
"0","km_fit_sex <- survfit(Surv(time, event) ~ factor(Sex), data = pen_data)"
"0",""
"0","# Calculate overall absolute penetrance"
"0","overall_abs_pen <- calculate_absolute_penetrance(km_fit_overall)"
"0",""
"0","# Calculate sex-specific absolute penetrance"
"0","male_abs_pen <- calculate_absolute_penetrance(km_fit_sex[2])"
"0","female_abs_pen <- calculate_absolute_penetrance(km_fit_sex[1])"
"0",""
"0","# Add sex labels"
"0","male_abs_pen$Sex <- ""Male"""
"0","female_abs_pen$Sex <- ""Female"""
"0",""
"0","# Combine for plotting"
"0","sex_abs_pen <- rbind(male_abs_pen, female_abs_pen)"
"0",""
"0","# Plot absolute penetrance - overall"
"0","p_abs_overall <- ggplot(overall_abs_pen, aes(x = interval_start, y = absolute_pen)) +"
"0","  geom_bar(stat = ""identity"", fill = ""steelblue"", alpha = 0.7) +"
"0","  labs("
"0","    title = ""Absolute TP53 Penetrance for Colorectal Cancer"","
"0","    subtitle = ""Probability of cancer onset within each 5-year interval"","
"0","    x = ""Age (years)"","
"0","    y = ""Absolute Penetrance"""
"0","  ) +"
"0","  theme_minimal() +"
"0","  scale_x_continuous(breaks = seq(0, 65, by = 10)) +"
"0","  scale_y_continuous(labels = scales::percent) +"
"0","  theme(axis.text.x = element_text(angle = 45, hjust = 1))"
"0",""
"0","# Plot absolute penetrance - sex-specific"
"0","p_abs_sex <- ggplot(sex_abs_pen, aes(x = interval_start, y = absolute_pen, fill = Sex)) +"
"0","  geom_bar(stat = ""identity"", position = ""dodge"", alpha = 0.7) +"
"0","  labs("
"0","    title = ""Sex-specific Absolute TP53 Penetrance for Colorectal Cancer"","
"0","    subtitle = ""Probability of cancer onset within each 5-year interval"","
"0","    x = ""Age (years)"","
"0","    y = ""Absolute Penetrance"""
"0","  ) +"
"0","  theme_minimal() +"
"0","  scale_x_continuous(breaks = seq(0, 65, by = 10)) +"
"0","  scale_y_continuous(labels = scales::percent) +"
"0","  scale_fill_manual(values = c(""Female"" = ""#E7B800"", ""Male"" = ""#2E9FDF"")) +"
"0","  theme(axis.text.x = element_text(angle = 45, hjust = 1))"
"0",""
"0","# Plot cumulative penetrance alongside absolute penetrance - FIXED VERSION"
"0","# Convert to long format for combined plotting"
"0","overall_pen_long <- overall_abs_pen %>%"
"0","  select(interval_start, absolute_pen, cumulative_pen) %>%"
"0","  tidyr::pivot_longer("
"0","    cols = c(absolute_pen, cumulative_pen),"
"0","    names_to = ""measure"","
"0","    values_to = ""value"""
"0","  )"
"0",""
"0","# Combined plot with FIXED LEGEND"
"0","p_combined <- ggplot() +"
"0","  # Add absolute penetrance bars"
"0","  geom_bar(data = subset(overall_pen_long, measure == ""absolute_pen""),"
"0","           aes(x = interval_start, y = value, fill = ""Absolute""),"
"0","           stat = ""identity"", alpha = 0.7) +"
"0","  # Add cumulative penetrance line"
"0","  geom_line(data = subset(overall_pen_long, measure == ""cumulative_pen""),"
"0","            aes(x = interval_start, y = value, color = ""Cumulative""),"
"0","            size = 1) +"
"0","  # Add cumulative penetrance points"
"0","  geom_point(data = subset(overall_pen_long, measure == ""cumulative_pen""),"
"0","             aes(x = interval_start, y = value, color = ""Cumulative""),"
"0","             size = 2) +"
"0","  # Labels"
"0","  labs("
"0","    title = ""TP53 Penetrance for Colorectal Cancer"","
"0","    subtitle = ""Comparing absolute and cumulative penetrance"","
"0","    x = ""Age (years)"","
"0","    y = ""Penetrance"""
"0","  ) +"
"0","  # Styling"
"0","  theme_minimal() +"
"0","  scale_x_continuous(breaks = seq(0, 65, by = 10)) +"
"0","  scale_y_continuous(labels = scales::percent) +"
"0","  # Separate legends for fill and color"
"0","  scale_fill_manual("
"0","    values = c(""Absolute"" = ""steelblue""),"
"0","    name = ""Penetrance Type"""
"0","  ) +"
"0","  scale_color_manual("
"0","    values = c(""Cumulative"" = ""#E7B800""),"
"0","    name = ""Penetrance Type"""
"0","  ) +"
"0","  # Combine the legends"
"0","  guides(fill = guide_legend(order = 1), "
"0","         color = guide_legend(order = 2)) +"
"0","  theme(axis.text.x = element_text(angle = 45, hjust = 1),"
"0","        legend.position = ""right"")"
"0",""
"0","# Print plots"
"0","print(p_abs_overall)"
