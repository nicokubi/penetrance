"0","# Load survival analysis package"
"0","library(survival)"
"0",""
"0","# Define a simple function to describe family characteristics"
"0","describeFamilies <- function(families) {"
"0","  # Initialize counters"
"0","  total_individuals <- 0"
"0","  total_affected <- 0"
"0","  total_carriers <- 0"
"0","  family_sizes <- numeric(length(families))"
"0","  "
"0","  # Calculate statistics for each family"
"0","  for (i in seq_along(families)) {"
"0","    fam <- families[[i]]"
"0","    family_sizes[i] <- nrow(fam)"
"0","    total_individuals <- total_individuals + nrow(fam)"
"0","    total_affected <- total_affected + sum(fam$isAff == 1, na.rm = TRUE)"
"0","    total_carriers <- total_carriers + sum(fam$geno == 1, na.rm = TRUE)"
"0","  }"
"0","  "
"0","  # Return a summary"
"0","  return(list("
"0","    num_families = length(families),"
"0","    total_individuals = total_individuals,"
"0","    avg_family_size = mean(family_sizes),"
"0","    min_family_size = min(family_sizes),"
"0","    max_family_size = max(family_sizes),"
"0","    total_affected = total_affected,"
"0","    total_carriers = total_carriers,"
"0","    avg_affected_per_family = total_affected / length(families),"
"0","    avg_carriers_per_family = total_carriers / length(families)"
"0","  ))"
"0","}"
"0",""
"0","# Function to prepare data for Kaplan-Meier analysis"
"0","prepareKaplanMeier <- function(families) {"
"0","  # Combine all individuals from all families"
"0","  all_data <- do.call(rbind, families)"
"0","  "
"0","  # Create gender factor"
"0","  all_data$gender <- factor(all_data$Sex, levels = c(1, 2), labels = c(""Male"", ""Female""))"
"0","  "
"0","  # Ensure we have the right columns"
"0","  if (""Age"" %in% colnames(all_data) && ""isAff"" %in% colnames(all_data) && ""geno"" %in% colnames(all_data)) {"
"0","    # Create status indicator (1 = event, 0 = censored)"
"0","    all_data$status <- as.numeric(all_data$isAff == 1)"
"0","    "
"0","    # Create a mutation carrier indicator (unknown genotype treated as non-carrier)"
"0","    all_data$carrier <- ifelse(all_data$geno == 1, ""Carrier"", ""Non-Carrier/Unknown"")"
"0","    "
"0","    # Return cleaned data"
"0","    return(all_data)"
"0","  } else {"
"0","    stop(""Required columns not found in data"")"
"0","  }"
"0","}"
"0",""
"0","# Analyze the reformatted family sets"
"0","family_descriptions <- list()"
"0",""
"0","for (i in seq_along(sample_sizes)) {"
"0","  size <- sample_sizes[i]"
"0","  set_name <- paste0(""fam"", size)"
"0","  "
"0","  if (!is.null(reformatted_sets[[set_name]])) {"
"0","    # Analyze the family data"
"0","    family_descriptions[[set_name]] <- describeFamilies(reformatted_sets[[set_name]])"
"0","    "
"0","    # Print the results"
"0","    cat(""\n"")"
"0","    cat(""===========================================\n"")"
"0","    cat(paste0(""Description of "", size, ""-Family Simulation Set\n""))"
"0","    cat(""===========================================\n"")"
"0","    "
"0","    desc <- family_descriptions[[set_name]]"
"0","    cat(paste0(""Number of families: "", desc$num_families, ""\n""))"
"0","    cat(paste0(""Total individuals: "", desc$total_individuals, ""\n""))"
"0","    cat(paste0(""Average family size: "", round(desc$avg_family_size, 2), "" (range: "", "
"0","              desc$min_family_size, ""-"", desc$max_family_size, "")\n""))"
"0","    cat(paste0(""Total affected individuals: "", desc$total_affected, "" ("", "
"0","              round(100*desc$total_affected/desc$total_individuals, 1), ""%)\n""))"
"0","    cat(paste0(""Total carriers: "", desc$total_carriers, "" ("", "
"0","              round(100*desc$total_carriers/desc$total_individuals, 1), ""%)\n""))"
"0","    cat(paste0(""Average affected per family: "", round(desc$avg_affected_per_family, 2), ""\n""))"
"0","    cat(paste0(""Average carriers per family: "", round(desc$avg_carriers_per_family, 2), ""\n""))"
"0","    cat(""\n"")"
"0","    "
"0","    # Perform Kaplan-Meier analysis if the sample has enough families"
"0","    if (desc$num_families >= 30 && desc$total_carriers >= 20) {"
"0","      cat(""Performing Kaplan-Meier analysis...\n"")"
"0","      "
"0","      # Prepare data for Kaplan-Meier"
"0","      km_data <- try(prepareKaplanMeier(reformatted_sets[[set_name]]), silent = TRUE)"
"0","      "
"0","      if (!inherits(km_data, ""try-error"")) {"
"0","        # Fit Kaplan-Meier models"
"0","        # 1. Overall survival by carrier status"
"0","        km_fit_carrier <- survfit(Surv(Age, status) ~ carrier, data = km_data)"
"0","        "
"0","        # 2. Survival by carrier status and gender"
"0","        km_fit_gender <- survfit(Surv(Age, status) ~ carrier + gender, data = km_data)"
"0","        "
"0","        # Plot the results"
"0","        par(mfrow = c(1, 2))"
"0","        "
"0","        # Plot 1: By carrier status"
"0","        plot(km_fit_carrier, "
"0","             xlab = ""Age"", "
"0","             ylab = ""Cancer-Free Probability"","
"0","             main = paste0(""Kaplan-Meier Curves (n="", size, "")""),"
"0","             col = c(""blue"", ""red""),"
"0","             lwd = 2,"
"0","             mark.time = TRUE)"
"0","        legend(""bottomleft"", "
"0","               legend = c(""Non-Carrier/Unknown"", ""Carrier""),"
"0","               col = c(""blue"", ""red""),"
"0","               lwd = 2,"
"0","               cex = 0.8)"
"0","        "
"0","        # Plot 2: By carrier status and gender"
"0","        plot(km_fit_gender, "
"0","             xlab = ""Age"", "
"0","             ylab = ""Cancer-Free Probability"","
"0","             main = ""By Carrier Status and Gender"","
"0","             col = c(""blue"", ""red"", ""darkblue"", ""darkred""),"
"0","             lwd = 2,"
"0","             mark.time = TRUE)"
"0","        legend(""bottomleft"", "
"0","               legend = c(""Non-Carrier/Unknown Male"", ""Carrier Male"", "
"0","                          ""Non-Carrier/Unknown Female"", ""Carrier Female""),"
"0","               col = c(""blue"", ""red"", ""darkblue"", ""darkred""),"
"0","               lwd = 2,"
"0","               cex = 0.7)"
"0","        "
"0","        par(mfrow = c(1, 1))"
"0","        "
"0","        # Calculate median survival times"
"0","        median_times <- summary(km_fit_carrier)$table[, ""median""]"
"0","        cat(""Median cancer-free survival times:\n"")"
"0","        for (j in 1:length(median_times)) {"
"0","          name <- names(median_times)[j]"
"0","          time <- median_times[j]"
"0","          if (is.na(time)) time <- "">max follow-up"""
"0","          cat(paste0(""  - "", name, "": "", time, "" years\n""))"
"0","        }"
"0","        "
"0","        # Perform log-rank test"
"0","        log_rank <- survdiff(Surv(Age, status) ~ carrier, data = km_data)"
"0","        cat(paste0(""Log-rank test: Chi-square = "", round(log_rank$chisq, 2), "
"0","                  "", df = "", length(log_rank$n) - 1, "
"0","                  "", p-value = "", round(1 - pchisq(log_rank$chisq, length(log_rank$n) - 1), 4), ""\n""))"
"0","      } else {"
"0","        cat(""Error preparing data for Kaplan-Meier analysis.\n"")"
"0","      }"
"0","    } else {"
"0","      cat(""Sample size too small for meaningful Kaplan-Meier analysis.\n"")"
"0","    }"
"0","  }"
"0","}"
"1","
"
"1","===========================================
"
"1","Description of 30-Family Simulation Set
"
"1","===========================================
"
"1","Number of families: 30
"
"1","Total individuals: 643
"
"1","Average family size: 21.43 (range: 12-44)
"
"1","Total affected individuals: 82 (12.8%)
"
"1","Total carriers: 30 (4.7%)
"
"1","Average affected per family: 2.73
"
"1","Average carriers per family: 1
"
"1","
"
"1","Performing Kaplan-Meier analysis...
"
"2","Error in summary(km_fit_carrier)$table[, ""median""] : 
  incorrect number of dimensions
"
